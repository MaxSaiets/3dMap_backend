# –ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–±–ª–µ–º –ª–æ–≥—ñ–∫–∏ –æ–±—Ä–æ–±–∫–∏ –±—É–¥—ñ–≤–µ–ª—å

## üî¥ –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò

### 1. **–ü–æ–¥–≤—ñ–π–Ω–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –£ `main.py` (—Ä—è–¥–æ–∫ 594-598): `_transform_building_geometries_to_local()` –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î `gdf_buildings.geometry.values` –∑ UTM –≤ –ª–æ–∫–∞–ª—å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è `flatten_heightfield_under_buildings`
- –£ `building_processor.py` (—Ä—è–¥–æ–∫ 43-64): `process_buildings()` –ó–ù–û–í–£ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î `gdf_buildings` –∑ UTM –≤ –ª–æ–∫–∞–ª—å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ë—É–¥—ñ–≤–ª—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –¥–≤—ñ—á—ñ, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ `flatten_heightfield_under_buildings` —Ç–∞ `process_buildings` –º–æ–∂—É—Ç—å –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏
- –ë—É–¥—ñ–≤–ª—ñ –º–æ–∂—É—Ç—å —Ä–æ–∑–º—ñ—â—É–≤–∞—Ç–∏—Å—è –Ω–µ —Ç–∞–º, –¥–µ –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–π —Ä–µ–ª—å—î—Ñ

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –≤–∂–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—ñ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –≤ `process_buildings`, –∞–±–æ
- –ü–µ—Ä–µ—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—ñ –¥–∞–Ω—ñ —Å–∫—Ä—ñ–∑—å

---

### 2. **–ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º—ñ–∂ flatten —Ç–∞ process_buildings**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `flatten_heightfield_under_buildings` –æ—Ç—Ä–∏–º—É—î –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –≤ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (—á–µ—Ä–µ–∑ `_transform_building_geometries_to_local`)
- `process_buildings` –æ—Ç—Ä–∏–º—É—î `gdf_buildings` –≤ UTM –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö —ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö —Å–∞–º
- –Ø–∫—â–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ —Ä—ñ–∑–Ω–∏–π —á–∞—Å –∞–±–æ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º–æ–∂—É—Ç—å –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –†–µ–ª—å—î—Ñ –≤–∏—Ä—ñ–≤–Ω—é—î—Ç—å—Å—è –ø—ñ–¥ –æ–¥–Ω–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏, –∞ –±—É–¥—ñ–≤–ª—è —Ä–æ–∑–º—ñ—â—É—î—Ç—å—Å—è –∑–∞ —ñ–Ω—à–∏–º–∏
- –ë—É–¥—ñ–≤–ª—è –º–æ–∂–µ –æ–ø–∏–Ω–∏—Ç–∏—Å—è —Ç–∞–º, –¥–µ —Ä–µ–ª—å—î—Ñ –ù–ï –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–π

**–†—ñ—à–µ–Ω–Ω—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –æ–¥–Ω—É —ñ —Ç—É –∂ —Ñ—É–Ω–∫—Ü—ñ—é –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–ª—è –æ–±–æ—Ö –º—ñ—Å—Ü—å
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –≤–∂–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—ñ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –≤ `process_buildings`

---

### 3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–∏—Å–æ—Ç–∏ —Ä–µ–ª—å—î—Ñ—É –ø—ñ–¥ –±—É–¥—ñ–≤–ª–µ—é**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `ground_heights_for_geom()` (—Ä—è–¥–æ–∫ 68-140):**
- –§—É–Ω–∫—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π —Å–µ–º–ø–ª—ñ–Ω–≥ (—Ç—ñ–ª—å–∫–∏ –∫–æ–Ω—Ç—É—Ä, –∫—É—Ç–æ–≤—ñ —Ç–æ—á–∫–∏, —Ü–µ–Ω—Ç—Ä–æ—ó–¥)
- –ê–ª–µ —è–∫—â–æ —Ä–µ–ª—å—î—Ñ –ù–ï –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–π (—á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É –≤ `flatten_heightfield_under_buildings`), –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—é
- –§—É–Ω–∫—Ü—ñ—è –±–µ—Ä–µ `ground_min = np.min(heights)`, –∞–ª–µ —è–∫—â–æ —Å–µ–º–ø–ª—ñ–Ω–≥ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–π, –º–æ–∂–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –Ω–∞–π–Ω–∏–∂—á—É —Ç–æ—á–∫—É

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ë—É–¥—ñ–≤–ª—è –º–æ–∂–µ –±—É—Ç–∏ —Ä–æ–∑–º—ñ—â–µ–Ω–∞ –≤–∏—â–µ, –Ω—ñ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –∞–±–æ –Ω–∞–≤–ø–∞–∫–∏ - –ø—ñ–¥ –∑–µ–º–ª–µ—é
- –ù–∞ —Å–∫–ª–∞–¥–Ω–æ–º—É —Ä–µ–ª—å—î—Ñ—ñ (–≤–µ–ª–∏–∫–∏–π —É—Ö–∏–ª) —Å–µ–º–ø–ª—ñ–Ω–≥ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–º

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü—ñ—Å–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Ä–µ–ª—å—î—Ñ—É, —Å–µ–º–ø–ª—ñ–Ω–≥ –º–æ–∂–µ –±—É—Ç–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–º (—Ä–µ–ª—å—î—Ñ –ø–ª–æ—Å–∫–∏–π)
- –ê–ª–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ `flatten_heightfield_under_buildings` –¥—ñ–π—Å–Ω–æ –≤–∏—Ä—ñ–≤–Ω—è–≤ —Ä–µ–ª—å—î—Ñ
- –î–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ —Ç–æ—á–æ–∫ —Å–µ–º–ø–ª—ñ–Ω–≥—É –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –±—É–¥—ñ–≤–µ–ª—å –∞–±–æ —Å–∫–ª–∞–¥–Ω–æ–≥–æ —Ä–µ–ª—å—î—Ñ—É

---

### 4. **–ü—Ä–æ–±–ª–µ–º–∞ –∑ –∞–≥—Ä–µ—Å–∏–≤–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –ø—ñ—Å–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `process_buildings()` (—Ä—è–¥–æ–∫ 233-259):**
- –ü—ñ—Å–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –±—É–¥—ñ–≤–ª—ñ –Ω–∞ `translate_z`, –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∏–∂–Ω—ñ—Ö –≤–µ—Ä—à–∏–Ω
- –ê–ª–µ `bottom_threshold = translate_z + 0.2` - —Ü–µ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫–µ –º–æ–∂–µ –Ω–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω—É —Ñ–æ—Ä–º—É –±—É–¥—ñ–≤–ª—ñ
- –Ø–∫—â–æ –±—É–¥—ñ–≤–ª—è –º–∞—î —Å–∫–ª–∞–¥–Ω—É —Ñ–æ—Ä–º—É –∞–±–æ –≤–µ–ª–∏–∫–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, –Ω–∏–∂–Ω—ñ –≤–µ—Ä—à–∏–Ω–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–µ —Ç—ñ

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–∂–µ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–ª—è –±—É–¥—ñ–≤–µ–ª—å –∑—ñ —Å–∫–ª–∞–¥–Ω–∏–º–∏ —Ñ–æ—Ä–º–∞–º–∏
- –ë—É–¥—ñ–≤–ª—è –º–æ–∂–µ –≤—Å–µ –æ–¥–Ω–æ –æ–ø–∏–Ω–∏—Ç–∏—Å—è –ø—ñ–¥ –∑–µ–º–ª–µ—é, —è–∫—â–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –Ω–∏–∂–Ω—ñ –≤–µ—Ä—à–∏–Ω–∏

**–†—ñ—à–µ–Ω–Ω—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–ª—å—à —Ä–æ–∑—É–º–Ω—É –ª–æ–≥—ñ–∫—É –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∏–∂–Ω—ñ—Ö –≤–µ—Ä—à–∏–Ω (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–∏–∂–Ω—ñ 10-20% –≤–∏—Å–æ—Ç–∏ –±—É–¥—ñ–≤–ª—ñ)
- –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –í–°–Ü –≤–µ—Ä—à–∏–Ω–∏, –∞ –Ω–µ —Ç—ñ–ª—å–∫–∏ —Ç—ñ, —â–æ –Ω–∏–∂—á–µ `translate_z + 0.2`

---

### 5. **–ü—Ä–æ–±–ª–µ–º–∞ –∑ `safety_margin` —Ç–∞ `embed_depth`**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `process_buildings()` (—Ä—è–¥–æ–∫ 197-206):**
```python
safety_margin = 0.1  # 10—Å–º –∑–∞–ø–∞—Å
ground_min_safe = ground_min + safety_margin
base_z = ground_min_safe - float(embed_depth)
translate_z = float(base_z) - float(foundation_depth_eff)
```

**–õ–æ–≥—ñ–∫–∞:**
- `ground_min_safe = ground_min + 0.1` - –¥–æ–¥–∞—î–º–æ 10—Å–º –¥–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ —Ä–µ–ª—å—î—Ñ—É
- `base_z = ground_min_safe - embed_depth` - –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ embed_depth (—è–∫—â–æ –≤—ñ–Ω > 0, —Ç–æ base_z —Å—Ç–∞—î –Ω–∏–∂—á–µ)
- `translate_z = base_z - foundation_depth_eff` - –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –Ø–∫—â–æ `embed_depth > 0`, —Ç–æ `base_z` —Å—Ç–∞—î –Ω–∏–∂—á–µ `ground_min_safe`, —â–æ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ —Ç–æ–≥–æ, —â–æ –±—É–¥—ñ–≤–ª—è –±—É–¥–µ —á–∞—Å—Ç–∫–æ–≤–æ –ø—ñ–¥ –∑–µ–º–ª–µ—é
- `safety_margin` –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ `ground_min`, –∞–ª–µ –ø–æ—Ç—ñ–º `embed_depth` –≤—ñ–¥–Ω—ñ–º–∞—î—Ç—å—Å—è, —â–æ –º–æ–∂–µ –∑–≤–µ—Å—Ç–∏ –Ω–∞–Ω—ñ–≤–µ—Ü—å –∑–∞–ø–∞—Å

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ë—É–¥—ñ–≤–ª—è –º–æ–∂–µ –±—É—Ç–∏ —á–∞—Å—Ç–∫–æ–≤–æ –ø—ñ–¥ –∑–µ–º–ª–µ—é, —è–∫—â–æ `embed_depth` –≤–µ–ª–∏–∫–∏–π
- –õ–æ–≥—ñ–∫–∞ –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—î, —â–æ `embed_depth` –º–∞—î –±—É—Ç–∏ –º–µ–Ω—à–∏–º –∑–∞ `safety_margin`

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ `base_z >= ground_min` (–Ω–µ –Ω–∏–∂—á–µ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ —Ä–µ–ª—å—î—Ñ—É)
- –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `base_z = max(ground_min_safe - embed_depth, ground_min)`

---

### 6. **–ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–æ–º –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏—Ö –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `flatten_heightfield_under_buildings()` (—Ä—è–¥–æ–∫ 721-723):**
```python
flattened_count = sum(1 for g in building_geometries for _ in _iter_polygons(g))
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ü–Ü–°–õ–Ø —Ü–∏–∫–ª—É, –∞–ª–µ —Ä–∞—Ö—É—î –í–°–Ü –ø–æ–ª—ñ–≥–æ–Ω–∏, –Ω–∞–≤—ñ—Ç—å —Ç—ñ, —â–æ –±—É–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ñ (—á–µ—Ä–µ–∑ `continue`)
- –†–µ–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏—Ö –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ –º–µ–Ω—à–æ—é

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–∫–∞–∑—É—î –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏—Ö –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø–ª—É—Ç–∞–Ω–∏–Ω–∏ –ø—Ä–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—Ü—ñ

**–†—ñ—à–µ–Ω–Ω—è:**
- –†–∞—Ö—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏, —â–æ –¥—ñ–π—Å–Ω–æ –±—É–ª–∏ –≤–∏—Ä—ñ–≤–Ω—è–Ω—ñ (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ü–∏–∫–ª—É)

---

## üü° –°–ï–†–ï–î–ù–Ü –ü–†–û–ë–õ–ï–ú–ò

### 7. **–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–π —Å–µ–º–ø–ª—ñ–Ω–≥ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –±—É–¥—ñ–≤–µ–ª—å**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `ground_heights_for_geom()` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Å–µ–º–ø–ª—ñ–Ω–≥ (–∫–æ–Ω—Ç—É—Ä, –∫—É—Ç–∏, —Ü–µ–Ω—Ç—Ä–æ—ó–¥)
- –î–ª—è –≤–µ–ª–∏–∫–∏—Ö –±—É–¥—ñ–≤–µ–ª—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 100x100 –º–µ—Ç—Ä—ñ–≤) —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ
- –ù–∞ —Å–∫–ª–∞–¥–Ω–æ–º—É —Ä–µ–ª—å—î—Ñ—ñ –º–æ–∂–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –≤–∞–∂–ª–∏–≤—ñ —Ç–æ—á–∫–∏

**–†—ñ—à–µ–Ω–Ω—è:**
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —Å–µ–º–ø–ª—ñ–Ω–≥: –±—ñ–ª—å—à–µ —Ç–æ—á–æ–∫ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –±—É–¥—ñ–≤–µ–ª—å
- –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—É —Å—ñ—Ç–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–ª—ñ–≥–æ–Ω—É

---

### 8. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ—Å–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Ä–µ–ª—å—î—Ñ—É**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—ñ—Å–ª—è –≤–∏–∫–ª–∏–∫—É `flatten_heightfield_under_buildings`, –Ω–µ–º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —â–æ —Ä–µ–ª—å—î—Ñ –¥—ñ–π—Å–Ω–æ –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–π
- –Ø–∫—â–æ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ (—á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É –≤ rasterize –∞–±–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö), –±—É–¥—ñ–≤–ª—è –≤—Å–µ –æ–¥–Ω–æ –±—É–¥–µ —Ä–æ–∑–º—ñ—â–µ–Ω–∞

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—ñ—Å–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è: –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤–∏—Å–æ—Ç–∏ –ø—ñ–¥ –±—É–¥—ñ–≤–ª–µ—é –¥—ñ–π—Å–Ω–æ –æ–¥–Ω–∞–∫–æ–≤—ñ
- –Ø–∫—â–æ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–ª—å—à –∞–≥—Ä–µ—Å–∏–≤–Ω—É –ª–æ–≥—ñ–∫—É —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è

---

### 9. **–ü—Ä–æ–±–ª–µ–º–∞ –∑ MultiPolygon**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–ª—è MultiPolygon –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç–æ–π —Å–∞–º–∏–π `translate_z` –¥–ª—è –≤—Å—ñ—Ö –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤
- –ê–ª–µ —Ä—ñ–∑–Ω—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–∞ —Ä—ñ–∑–Ω—ñ–π –≤–∏—Å–æ—Ç—ñ —Ä–µ–ª—å—î—Ñ—É
- –Ø–∫—â–æ –æ–¥–∏–Ω –ø–æ–ª—ñ–≥–æ–Ω –Ω–∞ –≥–æ—Ä—ñ, –∞ —ñ–Ω—à–∏–π –≤ –¥–æ–ª–∏–Ω—ñ, –≤–æ–Ω–∏ –±—É–¥—É—Ç—å —Ä–æ–∑–º—ñ—â–µ–Ω—ñ –Ω–∞ –æ–¥–Ω—ñ–π –≤–∏—Å–æ—Ç—ñ

**–†—ñ—à–µ–Ω–Ω—è:**
- –†–æ–∑—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ `translate_z` –æ–∫—Ä–µ–º–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É –≤ MultiPolygon

---

## üü¢ –î–†–Ü–ë–ù–Ü –ü–†–û–ë–õ–ï–ú–ò / –ü–û–ö–†–ê–©–ï–ù–ù–Ø

### 10. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–∞–ª–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
- –ù–µ–º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —á–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å –º—ñ–∂ flatten —Ç–∞ process_buildings

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —Ç–∞ –≤–∏—Å–æ—Ç–∞–º–∏
- –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

---

### 11. **–ü—Ä–æ–±–ª–µ–º–∞ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ë–∞–≥–∞—Ç–æ `try-except` –±–ª–æ–∫—ñ–≤, —è–∫—ñ –º–æ–≤—á–∞–∑–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å –ø–æ–º–∏–ª–∫–∏
- –í–∞–∂–∫–æ –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —â–æ —Å–∞–º–µ –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Ä—ñ–≤–Ω—ñ –ª–æ–≥—É–≤–∞–Ω–Ω—è (DEBUG, WARN, ERROR)

---

## üìã –ü–õ–ê–ù –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û):
1. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–¥–≤—ñ–π–Ω–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
2. ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º—ñ–∂ flatten —Ç–∞ process_buildings
3. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –ª–æ–≥—ñ–∫—É –∑ `safety_margin` —Ç–∞ `embed_depth`

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–õ–ò–í–û):
4. ‚úÖ –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–∏—Å–æ—Ç–∏ —Ä–µ–ª—å—î—Ñ—É –ø—ñ–¥ –±—É–¥—ñ–≤–ª–µ—é
5. ‚úÖ –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –∞–≥—Ä–µ—Å–∏–≤–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—ñ—Å–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è
6. ‚úÖ –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—ñ—Å–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Ä–µ–ª—å—î—Ñ—É

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 3 (–ü–û–ö–†–ê–©–ï–ù–ù–Ø):
7. ‚úÖ –ü–æ–∫—Ä–∞—â–∏—Ç–∏ —Å–µ–º–ø–ª—ñ–Ω–≥ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –±—É–¥—ñ–≤–µ–ª—å
8. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –æ–±—Ä–æ–±–∫—É MultiPolygon
9. ‚úÖ –î–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üîç –î–ï–¢–ê–õ–¨–ù–ò–ô –ê–ù–ê–õ–Ü–ó –ö–û–î–£

### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –≤–∏–∫–ª–∏–∫—ñ–≤:

1. **main.py:594-598** - `_transform_building_geometries_to_local()` –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è flatten
2. **terrain_generator.py:264** - `flatten_heightfield_under_buildings()` –≤–∏—Ä—ñ–≤–Ω—é—î —Ä–µ–ª—å—î—Ñ
3. **main.py:652** - `process_buildings()` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–º `gdf_buildings` (–≤ UTM)
4. **building_processor.py:43-64** - `process_buildings()` –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ó–ù–û–í–£
5. **building_processor.py:186** - `ground_heights_for_geom()` –æ—Ç—Ä–∏–º—É—î –≤–∏—Å–æ—Ç–∏ —Ä–µ–ª—å—î—Ñ—É
6. **building_processor.py:194-206** - –†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è `translate_z`
7. **building_processor.py:231** - –ë—É–¥—ñ–≤–ª—è —Ä–æ–∑–º—ñ—â—É—î—Ç—å—Å—è –Ω–∞ `translate_z`
8. **building_processor.py:233-259** - –ê–≥—Ä–µ—Å–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∏–∂–Ω—ñ—Ö –≤–µ—Ä—à–∏–Ω

### –ü—Ä–æ–±–ª–µ–º–Ω—ñ –º—ñ—Å—Ü—è:

1. **–ö—Ä–æ–∫ 1 vs –ö—Ä–æ–∫ 4**: –ü–æ–¥–≤—ñ–π–Ω–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
2. **–ö—Ä–æ–∫ 2 vs –ö—Ä–æ–∫ 5**: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º–æ–∂—É—Ç—å –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏
3. **–ö—Ä–æ–∫ 6**: –õ–æ–≥—ñ–∫–∞ –∑ `safety_margin` —Ç–∞ `embed_depth` –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø—ñ–¥ –∑–µ–º–ª–µ—é
4. **–ö—Ä–æ–∫ 8**: –ê–≥—Ä–µ—Å–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–∂–µ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —Ñ–æ—Ä–º

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á

1. **–Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è**: –ü–µ—Ä–µ—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—ñ –¥–∞–Ω—ñ —Å–∫—Ä—ñ–∑—å
2. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è**: –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, —â–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ flatten —Ç–∞ process_buildings —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å
3. **–ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è**: –ì–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏, —â–æ `base_z >= ground_min` –∑–∞–≤–∂–¥–∏
4. **–ë—ñ–ª—å—à —Ä–æ–∑—É–º–Ω–∞ –∞–≥—Ä–µ—Å–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∏–∂–Ω—ñ 10-20% –≤–∏—Å–æ—Ç–∏ –±—É–¥—ñ–≤–ª—ñ –∑–∞–º—ñ—Å—Ç—å —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ–≥–æ –ø–æ—Ä–æ–≥—É
5. **–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

